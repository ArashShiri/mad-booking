<%= form_for(@booking) do |f| %>
<% if @booking.errors.any? %>
	<div id="error_explanation">
		<h2><%= pluralize(@booking.errors.count, "error") %> prohibited this booking from being saved:</h2>
	
		<ul>
			<% @booking.errors.full_messages.each do |msg| %>
			<li>
				<%= msg %>
			</li>
			<% end %>
		</ul>
	</div>
<% end %>

<% flash.each do |name, msg| %>
	<%= content_tag :div, msg, class: "alert-box" %>
<% end %>

<% if (@booking.equipments.count == @booking.sign_in_times.count) and @booking.equipments.count > 0 %>
	<% disable_ui = true %>
<% else %>
	<% disable_ui = false %>
<% end %>

<div class="row">
	<div class="large-6 columns">
		<div class="section-container accordion" data-section="accordion">
			<section>
				<p class="title" data-section-title>
					<a href="#"> <span class="label radius right">3 items</span> Booking details </a>
				</p>
				<div class="content" data-section-content>
					<ul class="side-nav">
						<% if params[:ids] %>
							<% params[:ids].each do |id| %>
								<li>
									<a class="label radius secondary right remove">x</a>
									<%= Equipment.find(id).name %><span class="round secondary label">Booking</span>
									<%= hidden_field_tag "booking[equipment_ids][]", id %>
								</li>
							<% end %>
						<% end %>
						<% if @booking.equipments.count > 0 %>
							<% for equip in @booking.equipments %>
								<li>
									<%= equip.name %>
									<%= hidden_field_tag "booking[equipment_ids][]", equip.id %>
									<% if @booking.sign_in_times.key?(equip.id) %>
										<span id="status_<%= equip.barcode %>" class="success label">In</span> at <%= @booking.sign_in_times[equip.id] %>
									<% elsif @booking.sign_out_times.key?(equip.id) %>
										<%= hidden_field_tag "booking[sign_in_ids][]", nil, {:data => equip.id, :class => "scannable", :id => "bc_in_#{equip.barcode}"}%>
										<% if IceCube::Schedule.from_yaml(@booking.schedule).end_time < DateTime.now %>
											<span id="status_<%= equip.barcode %>" class="alert label">Overdue</span> out at <%= @booking.sign_out_times[equip.id] %>
										<% else %>
											<span id="status_<%= equip.barcode %>" class="label">Out</span> at <%= @booking.sign_out_times[equip.id] %>
										<% end %>
									<% else %>
										<%= hidden_field_tag "booking[sign_out_ids][]", nil, {:data => equip.id, :class => "scannable", :id => "bc_out_#{equip.barcode}"}%>
										<span id="status_<%= equip.barcode %>" class="secondary label">Booked</span>
									<% end %>
									<br />
								</li>
							<% end %>	
						<% end %>
					</ul>
				</div>
			</section>
		</div>
	</div>

	<div class="large-6 columns">
		<div class="field">
			<% username = @booking.user.nil? ? "" : @booking.user.username %>
			
			
			<%= f.text_field :user, :class => 'usersearch', :value => username, :disabled => disable_ui %>
			<%= check_box_tag 'create_if_new', 'create', false, :disabled => disable_ui %>
			<%= "Create user if new?"%>
			<div class="field">
				<h3><%= f.label :schedule %></h3>
				<% if @booking.schedule != nil %>
				<% s = IceCube::Schedule.from_yaml(@booking.schedule) %>
				<% sd = DateTime.parse(s.start_time.to_s) %>
				<% ed = DateTime.parse(s.end_time.to_s) %>
				<% start_d = sd.strftime("%m/%d/%Y") %>
				<% start_t = sd.strftime("%I:%M %p")%>
				<% end_d = ed.strftime("%m/%d/%Y") %>
				<% end_t = ed.strftime("%I:%M %p")%>
				<% else %>
				<% start_d = Time.now.strftime("%m/%d/%Y") %>
				<% start_t = Time.now.strftime("%I:%M %p") %>
				<% end_d = start_d %>
				<% end_t = start_t %>
				<% end %>
				<p>
					Start Date:
					<%= text_field_tag :schedule_start, start_d, :disabled => disable_ui, :class => 'date' %>
					<br />
					Start Time:
					<%= text_field_tag :schedule_start_time, start_t, :disabled => disable_ui, :class => 'time' %>
					<br />
					End Date:
					<%= text_field_tag :schedule_end, end_d, :disabled => disable_ui, :class => 'date' %>
					<br />
					End Time:
					<%= text_field_tag :schedule_end_time, end_t, :disabled => disable_ui, :class => 'time' %>
				</p>
			</div>
			<div class="field">
				<h3><%= f.label :comments %></h3>
				<%= f.text_area :comments, :disabled => disable_ui %>
			</div>
			<div class="actions">
				<% if !disable_ui %>
				<%= f.submit 'Update Booking', :class => 'large button success' %>
				<% end %>
			</div>
		</div>
	</div>
</div>
<% end %>